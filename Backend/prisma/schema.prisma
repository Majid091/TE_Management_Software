generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  manager
  employee
}

enum AccountStatus {
  active
  inactive
  suspended
}

enum EmployeeAvailability {
  available
  busy
  on_leave
  unavailable
}

enum ProjectStatus {
  planning
  in_progress
  on_hold
  completed
  cancelled
}

enum ProjectPriority {
  low
  medium
  high
  critical
}

enum AuditAction {
  create
  update
  delete
  login
  logout
}

enum AuditEntityType {
  user
  employee
  department
  project
  project_assignment
  revenue
}

model User {
  id                     BigInt         @id @default(autoincrement())
  email                  String         @unique @db.VarChar(255)
  passwordHash           String         @map("password_hash") @db.VarChar(255)
  role                   UserRole       @default(employee)
  accountStatus          AccountStatus  @default(active) @map("account_status")
  lastLoginAt            DateTime?      @map("last_login_at") @db.Timestamptz(6)
  passwordChangedAt      DateTime?      @map("password_changed_at") @db.Timestamptz(6)
  failedLoginAttempts    Int            @default(0) @map("failed_login_attempts")
  lockedUntil            DateTime?      @map("locked_until") @db.Timestamptz(6)
  refreshToken           String?        @map("refresh_token") @db.Text
  refreshTokenExpiresAt  DateTime?      @map("refresh_token_expires_at") @db.Timestamptz(6)
  createdAt              DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt              DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt              DateTime?      @map("deleted_at") @db.Timestamptz(6)

  employee               Employee?
  auditLogs              AuditLog[]

  @@index([email], map: "idx_users_email")
  @@index([role], map: "idx_users_role")
  @@index([accountStatus], map: "idx_users_account_status")
  @@index([deletedAt], map: "idx_users_deleted_at")
  @@map("users")
}

model Department {
  id          BigInt     @id @default(autoincrement())
  name        String     @unique @db.VarChar(255)
  description String?    @db.Text
  budget      Decimal    @default(0) @db.Decimal(15, 2)
  location    String?    @db.VarChar(255)
  email       String?    @db.VarChar(255)
  phone       String?    @db.VarChar(50)
  headId      BigInt?    @map("head_id")
  createdAt   DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt   DateTime?  @map("deleted_at") @db.Timestamptz(6)

  head        Employee?  @relation("DepartmentHead", fields: [headId], references: [id], onDelete: SetNull)
  employees   Employee[] @relation("DepartmentEmployees")
  projects    Project[]

  @@index([name], map: "idx_departments_name")
  @@index([headId], map: "idx_departments_head_id")
  @@index([deletedAt], map: "idx_departments_deleted_at")
  @@map("departments")
}

model Employee {
  id                  BigInt                 @id @default(autoincrement())
  userId              BigInt                 @unique @map("user_id")
  departmentId        BigInt                 @map("department_id")
  firstName           String                 @map("first_name") @db.VarChar(100)
  lastName            String                 @map("last_name") @db.VarChar(100)
  phone               String?                @db.VarChar(50)
  position            String                 @db.VarChar(255)
  availability        EmployeeAvailability   @default(available)
  hireDate            DateTime               @map("hire_date") @db.Date
  salary              Decimal?               @db.Decimal(12, 2)
  skills              String[]
  avatarUrl           String?                @map("avatar_url") @db.Text
  managerId           BigInt?                @map("manager_id")
  createdAt           DateTime               @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime               @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt           DateTime?              @map("deleted_at") @db.Timestamptz(6)

  user                User                   @relation(fields: [userId], references: [id], onDelete: Cascade)
  department          Department             @relation("DepartmentEmployees", fields: [departmentId], references: [id], onDelete: Restrict)
  manager             Employee?              @relation("EmployeeManager", fields: [managerId], references: [id], onDelete: SetNull)
  subordinates        Employee[]             @relation("EmployeeManager")
  departmentHeadOf    Department[]           @relation("DepartmentHead")
  managedProjects     Project[]
  projectAssignments  ProjectAssignment[]

  @@index([userId], map: "idx_employees_user_id")
  @@index([departmentId], map: "idx_employees_department_id")
  @@index([managerId], map: "idx_employees_manager_id")
  @@index([availability], map: "idx_employees_availability")
  @@index([firstName, lastName], map: "idx_employees_full_name")
  @@index([hireDate], map: "idx_employees_hire_date")
  @@index([deletedAt], map: "idx_employees_deleted_at")
  @@map("employees")
}

model Project {
  id                 BigInt            @id @default(autoincrement())
  name               String            @db.VarChar(255)
  description        String?           @db.Text
  status             ProjectStatus     @default(planning)
  priority           ProjectPriority   @default(medium)
  departmentId       BigInt            @map("department_id")
  managerId          BigInt            @map("manager_id")
  client             String?           @db.VarChar(255)
  startDate          DateTime          @map("start_date") @db.Date
  endDate            DateTime          @map("end_date") @db.Date
  budget             Decimal           @default(0) @db.Decimal(15, 2)
  progress           Int               @default(0)
  tags               String[]
  createdAt          DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime          @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt          DateTime?         @map("deleted_at") @db.Timestamptz(6)

  department         Department        @relation(fields: [departmentId], references: [id], onDelete: Restrict)
  manager            Employee          @relation(fields: [managerId], references: [id], onDelete: Restrict)
  projectAssignments ProjectAssignment[]
  revenueRecords     RevenueRecord[]

  @@index([departmentId], map: "idx_projects_department_id")
  @@index([managerId], map: "idx_projects_manager_id")
  @@index([status], map: "idx_projects_status")
  @@index([priority], map: "idx_projects_priority")
  @@index([startDate, endDate], map: "idx_projects_dates")
  @@index([client], map: "idx_projects_client")
  @@index([deletedAt], map: "idx_projects_deleted_at")
  @@map("projects")
}

model ProjectAssignment {
  id                   BigInt    @id @default(autoincrement())
  projectId            BigInt    @map("project_id")
  employeeId           BigInt    @map("employee_id")
  role                 String    @db.VarChar(255)
  allocationPercentage Int       @default(100) @map("allocation_percentage")
  assignedAt           DateTime  @default(now()) @map("assigned_at") @db.Date
  unassignedAt         DateTime? @map("unassigned_at") @db.Date
  createdAt            DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  project              Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  employee             Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([projectId, employeeId, unassignedAt], map: "unique_active_assignment")
  @@index([projectId], map: "idx_project_assignments_project_id")
  @@index([employeeId], map: "idx_project_assignments_employee_id")
  @@index([projectId, employeeId], map: "idx_project_assignments_active")
  @@index([assignedAt, unassignedAt], map: "idx_project_assignments_dates")
  @@map("project_assignments")
}

model RevenueRecord {
  id          BigInt    @id @default(autoincrement())
  projectId   BigInt    @map("project_id")
  amount      Decimal   @db.Decimal(15, 2)
  expense     Decimal   @default(0) @db.Decimal(15, 2)
  profit      Decimal   @db.Decimal(15, 2)
  periodStart DateTime  @map("period_start") @db.Date
  periodEnd   DateTime  @map("period_end") @db.Date
  description String?   @db.Text
  recordedAt  DateTime  @default(now()) @map("recorded_at") @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt   DateTime? @map("deleted_at") @db.Timestamptz(6)

  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId], map: "idx_revenue_project_id")
  @@index([periodStart, periodEnd], map: "idx_revenue_period")
  @@index([recordedAt], map: "idx_revenue_recorded_at")
  @@index([deletedAt], map: "idx_revenue_deleted_at")
  @@map("revenue_records")
}

model AuditLog {
  id         BigInt            @id @default(autoincrement())
  userId     BigInt?           @map("user_id")
  action     AuditAction
  entityType AuditEntityType   @map("entity_type")
  entityId   BigInt?           @map("entity_id")
  oldValues  Json?             @map("old_values") @db.JsonB
  newValues  Json?             @map("new_values") @db.JsonB
  ipAddress  String?           @map("ip_address") @db.Inet
  userAgent  String?           @map("user_agent") @db.Text
  createdAt  DateTime          @default(now()) @map("created_at") @db.Timestamptz(6)

  user       User?             @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId], map: "idx_audit_user_id")
  @@index([action], map: "idx_audit_action")
  @@index([entityType, entityId], map: "idx_audit_entity")
  @@index([createdAt], map: "idx_audit_created_at")
  @@map("audit_logs")
}
